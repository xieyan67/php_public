<?php
/**
 * Created by PhpStorm.
 * User: shaoshuai
 * Date: 2018/3/13
 * Time: 下午2:47
 */

//教师只读数据库
$mysqlServerName='qbdb.17kgk.com';
$mysqlUsername='questionbank_r';
$mysqlPassword='JustDoIt2015';
$mysqlDatabase='question-bank';

$mysqlTestServerName='123.57.209.247';
$mysqlTestUsername='questionbank';
$mysqlTestPassword='some_pass';
$mysqlTestDatabase='test';

$link=mysqli_connect($mysqlServerName,$mysqlUsername,$mysqlPassword,$mysqlDatabase) or die("error connecting") ;
mysqli_query($link,"set names 'utf8'");


$linkTest=mysqli_connect($mysqlTestServerName,$mysqlTestUsername,$mysqlTestPassword,$mysqlTestDatabase) or die("error connecting") ;
mysqli_query($linkTest,"set names 'utf8'");

if (!$link) {
    printf("Can't connect to MySQL Server. Errorcode: %s ", mysqli_connect_error());
    exit;
}



$mapArray = [
    1=>[170,
        557,
        560,
        569,
        574,
        578,
        581,
        587,
        591,
        601,
        665,
        693,
        706,
        747,
        817,
        823,
        824,
        840,
        870,
        878,
        889,
        915,
        934,
        1005,
        1449,
        1461,
        1468,
        1490,
        1526,
        1545,
        1560,
        1583,
        1607,
        1625,
        1656,
        1697,
        1698,
        1875,
        2185,
        2186,
        2187,
        2621,
        2622,
        2693,
        2694,
        2695,
        2696,
        2697,
        2835,
        2836,
        2837,
        2988,
        2989,
        2990,
        3048,
        3061,
        3071,
        3082,
        3147,
        3148,
        3149,
        3276,
        3281,
        3282,
        3283,
        3538,
        3539,
        3540,
        3703,
        3704,
        3731,
        3847,
        3866,
        4004,
        4007,
        4009,
        4010,
        4100,
        4106,
        4132,
        4150,
        4151,
        4205,
        4221,
        4222,
        4223,
        4234,
        4236,
        4259,
        4389,
        4391,
        4475,
        4478,
        4516,
        4518,
        4519,
        4520,
        4521,
        4522,
        4724,
        4852,
        4853,
        4854,
        4857,
        4858,
        4864,
        5013,
        5049,
        5107,
        5149,
        5171,
        5181,
        5190,
        5192,
        5193,
        5194,
        5195,
        5416,
        5441,
        5504,
        5505,
        5506,
        5533,
        5553,
        5587,
        5644,
        5651,
        5704,
        5705,
        5706,
        5855,
        5856,
        5857,
        5978,
    ],
    2=>[
        2699,
        3443,
        4001,
        4525,
        4526,
        4527,
        4528,
        4531,
        4534,
        4535,
        4709,
        5126,
        169,
        663,
        704,
        949,
        1047,
        1058,
        1061,
        1062,
        1063,
        1686,
        2117,
        2118,
        2119,
        2664,
        2665,
        2666,
        2667,
        2668,
        2669,
        2670,
        2671,
        3108,
        4422,
        4736,
        5253,
        5370,
        5427,
        5489,
        5966,
        5967,
        5968,
        5969,
        5970,
        5971,
        5972,

    ],
    3=>[179,
        227,
        277,
        296,
        316,
        339,
        351,
        361,
        372,
        404,
        422,
        474,
        490,
        513,
        518,
        530,
        534,
        536,
        537,
        538,
        539,
        540,
        541,
        542,
        543,
        544,
        545,
        546,
        548,
        549,
        559,
        564,
        570,
        575,
        579,
        584,
        590,
        602,
        613,
        617,
        618,
        630,
        650,
        662,
        671,
        681,
        686,
        688,
        703,
        749,
        808,
        820,
        822,
        828,
        829,
        830,
        865,
        866,
        890,
        891,
        892,
        956,
        973,
        998,
        1017,
        1039,
        1049,
        1124,
        1157,
        1158,
        1235,
        1275,
        1286,
        1315,
        1338,
        1374,
        1382,
        1402,
        1426,
        1438,
        1446,
        1462,
        1491,
        1525,
        1544,
        1562,
        1582,
        1602,
        1624,
        1645,
        1688,
        1689,
        1690,
        1691,
        2111,
        2612,
        2614,
        2616,
        2617,
        2685,
        2686,
        2687,
        2688,
        2689,
        2690,
        2691,
        2774,
        2829,
        2830,
        2831,
        2832,
        2833,
        2834,
        2841,
        2850,
        2856,
        2865,
        2893,
        2900,
        2901,
        2906,
        2972,
        2991,
        2999,
        3000,
        3001,
        3009,
        3010,
        3016,
        3024,
        3032,
        3034,
        3035,
        3091,
        3097,
        3113,
        3136,
        3137,
        3139,
        3141,
        3157,
        3252,
        3266,
        3286,
        3302,
        3303,
        3317,
        3318,
        3319,
        3320,
        3321,
        3327,
        3328,
        3341,
        3342,
        3347,
        3361,
        3401,
        3413,
        3424,
        3435,
        3448,
        3449,
        3490,
        3530,
        3531,
        3533,
        3581,
        3582,
        3597,
        3601,
        3606,
        3632,
        3654,
        3657,
        3671,
        3696,
        3700,
        3710,
        3714,
        3715,
        3717,
        3720,
        3721,
        3722,
        3723,
        3724,
        3733,
        3736,
        3737,
        3791,
        3794,
        3809,
        3837,
        3843,
        3844,
        3848,
        3863,
        3870,
        3873,
        3882,
        3942,
        3972,
        3978,
        3980,
        3989,
        4011,
        4014,
        4023,
        4031,
        4032,
        4048,
        4086,
        4087,
        4097,
        4119,
        4130,
        4133,
        4158,
        4167,
        4194,
        4196,
        4200,
        4219,
        4220,
        4237,
        4244,
        4245,
        4290,
        4330,
        4372,
        4477,
        4504,
        4515,
        4546,
        4547,
        4582,
        4595,
        4596,
        4725,
        4734,
        4741,
        4748,
        4868,
        4884,
        4891,
        4892,
        4893,
        5006,
        5037,
        5081,
        5085,
        5225,
        5295,
        5296,
        5351,
        5357,
        5372,
        5383,
        5392,
        5407,
        5417,
        5472,
        5544,
        5552,
        5567,
        5568,
        5585,
        5602,
        5619,
        5643,
        5715,
        5716,
        5722,
        5749,
        5768,
        5770,
        5772,
        5773,
        5777,
        5834,
        5882,
        5884,
        5888,
        5922,
        5957,],
    4=>[
        3822,
        4717,
        5840,
        5883,
        191,
        421,
        1006,
        1179,
        1230,
        1350,
        1685,
        1687,
        2702,
        2703,
        2704,
        2705,
        2706,
        2707,
        2708,
        2887,
        2888,
        2980,
        3047,
        3106,
        3817,
        3899,
        4270,
        4420,
        5608,
        5880,
        5911,
        5914,
        5915,
        5916,
        5917,
        5919,
        5921,
        5926,

    ]
];


$i = 0;
$count = 1000;

while(true) {

    foreach (range(0, 49) as $num) {
        $startRow = $i * $count;
        $selectSql = "select uid from `user_active_2017_kgk` where uid%50 = {$num} order by id";
        $results = mysqli_query($linkTest, $selectSql);
        $result = array_reduce(mysqli_fetch_all($results), function ($result, $value) {
            return array_merge($result, array_values($value));
        }, array());
        $uidArray = implode(',', $result);

        getUserWatchStatusBy($num,$uidArray,$link,'2017-09','2017-10','2017_09_active',$linkTest,$result);
        getUserWatchStatusBy($num,$uidArray,$link,'2017-10','2017-11','2017_10_active',$linkTest,$result);
        getUserWatchStatusBy($num,$uidArray,$link,'2017-11','2017-12','2017_11_active',$linkTest,$result);
        getUserWatchStatusBy($num,$uidArray,$link,'2017-12','2018-01','2017_12_active',$linkTest,$result);
        getUserWatchStatusBy($num,$uidArray,$link,'2018-01','2018-02','2018_01_active',$linkTest,$result);
        getUserWatchStatusBy($num,$uidArray,$link,'2018-02','2018-03','2018_02_active',$linkTest,$result);
        getUserWatchStatusBy($num,$uidArray,$link,'2018-03','2018-04','2018_03_active',$linkTest,$result);
        getUserWatchStatusBy($num,$uidArray,$link,'2018-04','2018-05','2018_04_active',$linkTest,$result);
        getUserWatchStatusBy($num,$uidArray,$link,'2018-05','2018-06','2018_05_active',$linkTest,$result);
        getUserWatchStatusBy($num,$uidArray,$link,'2018-06','2018-07','2018_06_active',$linkTest,$result);
        getUserWatchStatusBy($num,$uidArray,$link,'2018-07','2018-08','2018_07_active',$linkTest,$result);
        getUserWatchStatusBy($num,$uidArray,$link,'2018-08','2018-09','2018_08_active',$linkTest,$result);
        getUserWatchStatusBy($num,$uidArray,$link,'2018-09','2018-10','2018_09_active',$linkTest,$result);
        getUserWatchStatusBy($num,$uidArray,$link,'2018-10','2018-11','2018_10_active',$linkTest,$result);
        getUserWatchStatusBy($num,$uidArray,$link,'2018-11','2018-12','2018_11_active',$linkTest,$result);
        getUserWatchStatusBy($num,$uidArray,$link,'2018-12','2019-01','2018_12_active',$linkTest,$result);
        getUserWatchStatusBy($num,$uidArray,$link,'2019-01','2019-02','2019_01_active',$linkTest,$result);
        getUserWatchStatusBy($num,$uidArray,$link,'2019-02','2019-03','2019_02_active',$linkTest,$result);
        getUserWatchStatusBy($num,$uidArray,$link,'2019-03','2019-04','2019_03_active',$linkTest,$result);

        var_dump($num . '执行完成！！');
        if ($num == 49){
            break 2;
        }
    }

    var_dump($i * $count . '-----' . (($i + 1) * $count) . '执行完成！！');
    var_dump(count($result), $count);
    $i++;

    if (count($result) < $count) {
        break;
    }
}

function getUserWatchStatusBy($submitTableNum,$uid,$link,$startTime,$endTime,$key,$linkTest,$uidArr){
    //筛选符合看课
    $selectSql = "select user_id from tc_user_watch_length_log where user_id in ({$uid}) 
        and start_time >= '{$startTime}' and start_time < '{$endTime}'  group by `user_id` HAVING count(id) >= 3";
    $result = mysqli_query($link, $selectSql);
    while ($row = mysqli_fetch_assoc($result)){
        unset($uidArr[array_search($row['user_id'],$uidArr)]);

        $updateSql = "update user_active_2017_kgk set
        {$key} = 1
        where uid = {$row['user_id']} and {$key} = 0";
        mysqli_query($linkTest,$updateSql);
    }

    if(!empty($uidArr)){
        $uid = implode(',',$uidArr);
        //筛选符合刷题
        $selectSql = "select id,uid from submit_logs_{$submitTableNum} where uid in ({$uid})
        and create_time >= '{$startTime}' and create_time < '{$endTime}' group by uid HAVING count(id) >= 3";
        $result = mysqli_query($link, $selectSql);
        while ($row = mysqli_fetch_assoc($result)){
            $updateSql = "update user_active_2017_kgk set
            {$key} = 1
            where uid = {$row['uid']} and {$key} = 0";
            mysqli_query($linkTest,$updateSql);
        }
    }
}

mysqli_close($link);